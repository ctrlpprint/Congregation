@model System.Collections.Generic.IList<Congregation.Core.Models.Families.Family>

@{
	ViewBag.Title = "Map";
}

<h2>Where we are</h2>

<div id="map_canvas" class="map rounded"></div>

<ul id="map_data">
	@foreach(var family in Model.Where(f => f.HasAddress())) {
		<li data-mapping='{"id":"@family.Id","latlng":{"lat":"@family.Address.Lat","lng":"@family.Address.Lng"},"tags":""}'>
			<div class="info-box">
				<h3>@string.Join(" and ", family.Contacts.Select(c => c.FirstName)) @family.FamilyName</h3>
				@foreach(var contact in family.Contacts.Where(c => c.FacebookId.Value.Length > 0)) {
					<img src="http://graph.facebook.com/@contact.FacebookId/picture" style="float: left;" />
				}
				<p>@family.Address.ToString()</p>

				
			</div>		</li>
 }
</ul>

@section Styles {
	<style type="text/css">
		.map { width: 100%; height:600px; }
	</style>
}

@section Script {
	<link href="@Url.Content("~/Content/Leaflet.css")" media="all" rel="stylesheet" type="text/css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.ie.css" /><![endif]-->
	<script src="http://leaflet.cloudmade.com/dist/leaflet.js" type="text/javascript"></script>
	<script src="@Url.Content("~/Scripts/mapstraction/mxn.js?(leaflet)")" type="text/javascript"></script> 
}

@section LateScript {
		
	<script type="text/javascript">

		var addMarker = function (latLon, description, icon) {
			// add a marker
			var marker = new mxn.Marker(latLon);
			marker.addData({ 'infoBubble': description });
			if (icon != null) {
				marker.setIcon('@Url.Content("~/Content/images/Map-Marker-Pink-48.png")', [48, 48]);
			}
			map.addMarker(marker);
			marker.openBubble();
			return marker;
		};

		$(function () {

			$("#map_data").hide();

			// create mxn object
			map = new mxn.Mapstraction('map_canvas', 'leaflet');
			map.setMapType(mxn.Mapstraction.ROADS);

			// Church
			var church = new mxn.LatLonPoint(-43.552526, 172.625231);
			var marker = addMarker(church, "<h2>St Saviours Church</h2>", true);


			$("[data-mapping]").each(function (i, el) {
				var data = $(el).data('mapping');
				var latLng = new mxn.LatLonPoint(data.latlng.lat, data.latlng.lng);
				var description = $(el).find('.info-box').html();
				addMarker(latLng, description, null);

			});

			// put map on page
			map.setCenterAndZoom(church, 12);
			map.addSmallControls(); // Leaflet doesn't support large controls


		});
	</script>
}
